
					<b>Last Week</b>: <a href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22484" target="_blank" original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22484">APU Overview and Square 1 Basics</a><br><br><b>This week</b>: We will learn how to makes sounds with the Square 2 and Triangle channels.<br><br><font size="4" style="font-weight: bold;">Square 2</font><br><br>Last
time we produced a beep on the Square 1 channel by making writes to
$4000-$4003.&#xA0; Now we&apos;ll learn how to do it with Square 2.&#xA0; This is very
easy because Square 1 and Square 2 are almost identical.&#xA0; We control
the Square 2 channel with ports $4004-$4007, and they more or less
mirror Square 1&apos;s $4000-4003.<br><br><span style="font-family: Courier New;"><b>SQ2_ENV</b> ($4004)</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">76543210</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||||||</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||++++- Volume</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">|||+----- Saw Envelope Disable (0: use internal counter for volume; 1: use Volume for volume)</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||+------ Length Counter Disable (0: use Length Counter; 1: disable Length Counter)</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">++------- Duty Cycle</span><br><br>
<br><span style="font-family: Courier New;"><b>SQ2_SWEEP</b> ($4005)</span><br>Skip this for now.&#xA0; This port, incidentally, is where Square 2 differs from Square 1.<br><br style="font-family: Courier New;"><span style="font-family: Courier New;"><b><br>
SQ2_LO</b> ($4006)</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">76543210</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||||||</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">++++++++- Low 8-bits of period</span><br><br><span style="font-family: Courier New;"><b><br>
SQ2_HI</b> ($4007)</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">76543210</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||||||</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">|||||+++- High 3-bits of period</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">+++++---- Length Counter</span><br><br>To produce a sound, first we enable the channel via $4015:<br><br><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%00000010 ;enable Square 2</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4015</span><br>&#xA0;&#xA0; &#xA0;<br>Then we write to the Square 2 ports:<br><br><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%00111000 ;Duty Cycle 00, Volume 8 (half volume)</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4004</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$A9&#xA0;&#xA0; ;$0A9 is an E in NTSC mode</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4006</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$00</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4007</span><br>&#xA0;&#xA0; &#xA0;<br>Except for sweeps, the Square 2 channel works just like the Square 1 channel.<br>&#xA0;&#xA0; &#xA0;<br><b><font size="4">Triangle</font></b><br><br>The
Triangle channel produces triangle waveforms which have a smooth sound
to them.&#xA0; Think of the flute-like melody in the Dragon Warrior overland
song.&#xA0; That&apos;s the Triangle.<br><br>Unlike the Square channels, we have
no control over the Triangle channel&apos;s volume or tone.&#xA0; It makes only
one type of sound and it&apos;s either on (playing) or off (silent).&#xA0; We
manipulate the Triangle channel via ports $4008-$400B.<br><br style="font-family: Courier New;"><span style="font-family: Courier New;">TRI_CTRL ($4008)</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">76543210</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||||||</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">|+++++++- Value</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">+-------- Control Flag (0: use internal counters; 1: disable internal counters)</span><br><br>The
triangle channel has two internal counters that can be used to
automatically control note duration.&#xA0; We are going to disable them so
that we can control note length manually.&#xA0; We will set the <b>Control Flag</b> to 1 and forget about it.<br><br>When the internal counters are disabled, <b>Value</b>
controls whether the channel is on or off.&#xA0; To silence the channel, set
Value to 0.&#xA0; To turn the channel on (ie, unsilence), set Value to any
non-zero value.&#xA0; Here are some examples:<br><br><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%10000000 ;silence the Triangle channel</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4008</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%10000001 ;Triangle channel on</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4008</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%10001111 ;Triangle channel on</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4008</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%11111111 ;Triangle channel on</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4008</span><br>&#xA0;&#xA0; &#xA0;<br>Note that the last three examples are functionally the same.&#xA0; Any non-zero value in Value makes the Triangle channel play.<br><br><b>Unused Port</b><br>$4009 is unused<br><br><b>Setting the Note</b><br>$400A
and $400B control the period of the wave, or in other words what note
you hear (A, C#, G, etc).&#xA0; Like the Squares, Triangle periods are
11-bits long.&#xA0; $400A holds the low 8-bits and $400B holds the high
3-bits of the period.&#xA0; We&apos;ll learn more about periods next week, but
for now just know that changing the values written to these ports will
change the note that is played.<br><br><span style="font-family: Courier New;">TRI_LO ($400A)</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">76543210</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||||||</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">++++++++- Low 8-bits of period</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">TRI_HI ($400B)</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">76543210</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">||||||||</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">|||||+++- High 3-bits of period</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">+++++---- Length Counter</span><br><br>The
Length Counter, if enabled, controls how long the note is played.&#xA0; We
disabled it up in the $4008 section, so we can forget about it for now.<br><br>Here is some code to play an eternal beep on the Triangle channel:<br><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%00000100 ;enable Triangle channel</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4015</span><br style="font-family: Courier New;"><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%10000001 ;disable counters, non-zero Value turns channel on</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4008</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$42&#xA0;&#xA0; ;a period of $042 plays a G# in NTSC mode.</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $400A</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$00</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $400B</span><br>&#xA0;&#xA0; &#xA0;<br><font size="4"><b>Multiple Beeps</b></font><br>We
now know how to use the Square 1, Square 2 and Triangle channels to
make sound.&#xA0; It doesn&apos;t take too much extra work to make them all play
at the same time.&#xA0; We just have to enable all three channels via $4015
and then write to the ports.&#xA0; Here&apos;s some code that will play a C#m
chord (C# E G#) using the knowledge we have gained up to now:<br><br><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%00000111&#xA0; ;enable Sq1, Sq2 and Tri channels</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4015</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; ;Square 1</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%00111000&#xA0; ;Duty 00, Volume 8 (half volume)</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4000</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$C9&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ;$0C9 is a C# in NTSC mode</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4002&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ;low 8 bits of period</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$00</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4003&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ;high 3 bits of period</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; ;Square 2</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%01110110&#xA0; ;Duty 01, Volume 6</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4004</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$A9&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ;$0A9 is an E in NTSC mode</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4006</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$00</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4007</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; ;Triangle</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #%10000001&#xA0; ;Triangle channel on</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $4008</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$42&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ;$042 is a G# in NTSC mode</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $400A</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; lda #$00</span><br style="font-family: Courier New;"><span style="font-family: Courier New;">&#xA0;&#xA0;&#xA0; sta $400B</span><br>&#xA0;&#xA0; &#xA0;<br><b>Putting It All Together</b><br>Download
and unzip the <a href="downloads/NerdyNightsSoundSourceCollection/triad.zip" target="_blank" original-href="http://tummaigames.com/triad.zip">triad.zip</a> sample files. All the code above is in the
triad.asm file. Make sure triad.asm and triad.bat are all in the same
folder as NESASM3, then double click triad.bat. That will run NESASM3
and should produce the triad.nes file. Run that NES file in FCEUXD SP
to listen to your C#m chord!&#xA0; Edit triad.asm to change the Volume and
Duty Cycle for the square waves.&#xA0; Try changing the Periods to produce
different notes.<br><br>Try to silence the various channels by either disabling them via $4015 or silencing them via $4000/$4004/$4008.<br><br>Finally try writing some code that will silence/unsilence the individual channels based on user input, like so:<br><br><span style="font-weight: bold;">A</span>: toggle Square 1 channel on/off<br><span style="font-weight: bold;">B</span>: toggle Square 2 channel on/off<br><span style="font-weight: bold;">Select</span>: toggle Triangle channel on/off<br><br><b>Next Week</b>: <a href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776" target="_blank" original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776">Periods and Lookup Tables</a><br>
				